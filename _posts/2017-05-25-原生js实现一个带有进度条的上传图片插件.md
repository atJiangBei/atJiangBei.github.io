---
layout: post
title: '有进度条的图片上传插件'
date: 2017-05-25
author: jiangbei
tags: function
---

**序言：**在某公司遇到的需求，当时由于各种原因写的含匆忙，现在看来实现略显粗糙，现在这里记录一下

## ajax+FileReader

### 1，ajax

```javascript
var ajaxUntil = {
	ajax: function(url, data,successFn, process,failFn) {
		//声明一个XHR对象
		var xhr = window.XMLHttpRequest ? new XMLHttpRequest() : new ActiveXObject('Microsoft.XMLHTTP');
		var uploadprogress=new Uploadprogress();
		xhr.addEventListener("loadstart",function(event){//接收到响应数据第一个开始
			uploadprogress.show();
		});
		xhr.upload.addEventListener("progress",function(event){//接收期间数据持续不断出发
			//event.loaded=>已上传数据；//event.total=>数据总量；
			var data=event;
			uploadprogress.progress(Math.round(event.loaded/event.total*100));
			process(data);
		});
		xhr.addEventListener("error",function(event){//发生错误时
			
		});
		xhr.addEventListener("load",function(event){//
			
		});
		xhr.addEventListener("loadend",function(event){//
			uploadprogress.hide();
		});
		xhr.onreadystatechange = function() { //当准备情况改变时触发事件
			if (xhr.readyState == 4) { //当准备情况为完成状态时
				if (xhr.status == 200) { //当返回的状态码为200（成功返回了数据）
					successFn(xhr.responseText); //执行后续操作
				} else if (failFn) {
					failFn(); //接受失败，执行相关操作
				}
			}
		}
		xhr.open("POST", url, true); //调用open方法
		xhr.send(data); //调用send方法
	}
};


```

## 2，进度条模块

```javascript

function Uploadprogress(){
	this.maxObj = null;
    this.callBack = function() {};
    var _this = this;
    if (!document.getElementById("uploadprogress")) {
    	var _html="";
    		_html+='<div style="width:100%;position:absolute;left:0;top:50%;height: 20px;margin-top: -20px;overflow: hidden;background-color: #f5f5f5;border-radius: 4px;box-shadow: inset 0 1px 2px rgba(0,0,0,.1);">';
			_html+='<div id="progress" style="width: 0;height: 100%;background-color: #337ab7;box-shadow: inset 0 -1px 0 rgba(0,0,0,.15);"></div>';
			_html+='</div>'
    	this.maxObj=document.createElement("div");
        this.maxObj.setAttribute("id","uploadprogress");
        this.maxObj.setAttribute("style",
        	"position:fixed;left:0;display:none;top:0;width:100%;height:100%;background:rgba(0,0,0,0.3);"
        )
        this.maxObj.innerHTML=_html;
        document.body.appendChild(this.maxObj);
    }else{
    	this.maxObj = document.getElementById("uploadprogress");
    }
}
Uploadprogress.prototype={
	constructor:Uploadprogress,
	show:function(){
		this.maxObj.style.display="block";
	},
	hide:function(){
	   this.maxObj.style.display="none";
	   document.getElementById("progress").style.width="0%";
	},
	progress:function(evt){
	   document.getElementById("progress").style.width=evt+"%";
	}		
};


```

## 3，弹出层模块

```javascript

function hintConfirm() {
    this.maxObj = null;
    this.callBack = function() {};
    var _this = this;
    if (!document.getElementById("maxObj")) {
        var _html = '';
        _html += '  <div style="position:relative;width:3.6rem;margin:2rem auto;border-radius:5px;overflow:hidden;background:#fff;border:1px solid #1E80E5;">';
        _html += '  <div style="height:0.42rem;line-height:0.42rem;background:#1E80E5;text-align:center;font-size:0.22rem;color:#fff;">温馨提示</div>';
        _html += '      <p id="confirmText" style="line-height: 0.24rem;font-size: 0.16rem;text-indent: 1.5em;padding: 0.12rem;"></p>';
        _html += '      <a id="confirmClone" style="position:absolute;right:0;top:0;width:0.36rem;text-align:center;height:0.42rem;font-size:0.3rem;color:#fff;">x</a>';
        _html += '      <a id="yesClone" style="display: block;height: 0.36rem;line-height: 0.36rem;font-size: 0.2rem;color: #fff;background: #1E80E5;text-align:center;margin: 0 auto;margin-bottom:0.1rem;width: 42%;border-radius: 0.05rem;">确定</a>';
        _html += '  </div>';
        this.maxObj=document.createElement("div");
        this.maxObj.setAttribute("id","maxObj");
        this.maxObj.setAttribute("style",
        	"position:fixed;left:0;top:0;display:none;width:100%;height:100%;background:rgba(0,0,0,0.3);"
        )
        this.maxObj.innerHTML=_html;
        document.body.appendChild(this.maxObj);
    }else{
        	this.maxObj=document.getElementById("maxObj");
        };
    document.getElementById("confirmClone").onclick=function(){
		_this.hide();
	};
    document.getElementById("yesClone").onclick=function(){
		_this.hide();
		_this.callBack.call(this);
	};
};
	
hintConfirm.prototype.show = function(txt, fn) {
	this.maxObj.style.display="block";
	 document.getElementById("confirmText").innerHTML=txt;
	if (typeof fn == 'function') {
		 this.callBack = fn;
	 }
    return this;
};
hintConfirm.prototype.hide = function() {
	 this.maxObj.style.display="none";
	return this;
};

```

## 4，图片上传模块

```javascript

var ImgFileGet_class = function(msg){

    this.fileObj = msg.fileObj;  //file-input的选择器
    this.max_size = 1024*1024*2 || false;  //图片最大大小，不设为无限度
    this.ajaxInterace = msg.ajaxInterace; //ajax上传图片插件

    	var _this = this;
        var reader = new FileReader();
        var file = this.fileObj;
       reader.onload = function(e){
          var com_rate = 1;

          if((_this.max_size!==false) && (file.size>_this.max_size)){
              com_rate =  _this.max_size/file.size;
          }

          _this.compressImg(e.target.result,com_rate,function(src_data){
              if(_this.ajaxInterace){
                _this.ajaxInterace(src_data);
              }
          });

        }
        reader.readAsDataURL(file);


    this.compressImg = function(imgData,com_rate,onCompress){
          if(!imgData)return;
          onCompress = onCompress || function(){};
          com_rate = com_rate || 1;//压缩比率默认为1
          var img = new Image();
          img.onload = function(){ 
              if(com_rate!=1) {//按最大高度等比缩放
                var rate = Math.sqrt(com_rate) ;
                img.width  *= rate; 
                img.height *= rate; 
              }
              var canvas = document.createElement('canvas');
              var ctx = canvas.getContext("2d"); 
              canvas.width =  img.width; 
              canvas.height = img.height; 
              ctx.clearRect(0, 0, canvas.width, canvas.height); // canvas清屏
              ctx.drawImage(img, 0, 0, img.width, img.height); // 将图像绘制到canvas上 
              onCompress(canvas.toDataURL("image/jpeg"));//必须等压缩完才读取canvas值，否则canvas内容是黑帆布
          };
        img.src = imgData;
    }
}

```


## 最后

```javascript
$.fn.uploadImg=function(msg){
	var hintconfirm=new hintConfirm();
	$(this).on("change",function(){
		this.url=msg.url;
		this.successFn=msg.successFn||function(){};
		this.process=msg.process||function(){};
		var _this=this;
		console.log(this.files)
			var fileObj=this.files[0];
			if(fileObj.name.length > 50){
				hintconfirm.show("文件名的长度不能超过50个字符");
				return false;
			};
			if(!fileObj.type.match('image\/(jpeg|jpg|png)')){
				hintconfirm.show("请上传格式为(jpg,gif,png,bmp)的图片");
				return false;
			};
			if(fileObj.size>1024*1024*10){
				hintconfirm.show("你好，你所上传的图片大小不能超过10m");
				return false;
			};
			var formdata = new FormData();
				var ImgFileGet = new ImgFileGet_class({
					fileObj:fileObj,  //fileInput选择器
					ajaxInterace:function(src_data){
						var cont_index = src_data.indexOf("base64,")+7;  //base64编码的图片，类型为jpeg
						formdata.append('content', src_data.substring(cont_index));
						console.log(src_data.substring(cont_index))
						ajaxUntil.ajax(_this.url,formdata,function(data){
							_this.successFn(data,_this);
						},function(e){
							_this.process(e);
						})
					}
				});
	});
}
```